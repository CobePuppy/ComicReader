# ComicReader 开发者文档

## 项目概述

ComicReader是一个基于Qt的现代化漫画阅读器，采用C++17开发，提供高性能的漫画阅读体验。

### 核心特性

- **多格式支持**: CBZ、CBR、ZIP、RAR等常见漫画格式
- **智能缓存**: 内存和磁盘两级缓存系统
- **书签系统**: 完整的书签和阅读进度管理
- **下载管理**: 支持断点续传的下载管理器
- **错误处理**: 统一的错误处理和日志系统
- **模块化设计**: 清晰的模块边界和依赖关系

## 构建环境

### 系统要求

**最低要求**
- Qt 6.0或更高版本
- C++17兼容编译器
- CMake 3.16或更高版本

**推荐配置**
- Qt 6.9.1
- GCC 9+ / Clang 10+ / MSVC 2019+
- CMake 3.20+

### 依赖库

**核心依赖**
```cmake
Qt6::Core
Qt6::Widgets
Qt6::Network
Qt6::Gui
```

**可选依赖**
```cmake
Qt6::Test        # 单元测试
Qt6::Concurrent  # 多线程支持
```

## 项目结构

```
ComicReader/
├── src/                    # 源代码
│   ├── main.cpp           # 程序入口
│   ├── MainWindow.h/cpp   # 主窗口
│   ├── widgets/           # UI组件
│   ├── managers/          # 管理器类
│   ├── dialogs/           # 对话框
│   └── utils/             # 工具类
├── tests/                 # 单元测试
├── docs/                  # 文档
├── resources/             # 资源文件
└── CMakeLists.txt        # 构建配置
```

### 核心模块

#### 1. CacheManager (缓存管理器)

**文件**: `src/managers/CacheManager.h/cpp`

**职责**:
- 管理内存和磁盘缓存
- 提供异步图片加载
- 缓存压缩和清理

**关键接口**:
```cpp
class CacheManager {
public:
    // 异步获取页面图片
    void getPageAsync(const QString &path, int pageIndex, 
                     std::function<void(const QPixmap&)> callback);
    
    // 设置缓存大小限制
    void setMemoryCacheLimit(int sizeMB);
    void setDiskCacheLimit(int sizeMB);
    
    // 缓存清理
    void clearMemoryCache();
    void clearDiskCache();
};
```

#### 2. BookmarkManager (书签管理器)

**文件**: `src/managers/BookmarkManager.h/cpp`

**职责**:
- 书签的增删改查
- 阅读进度跟踪
- 数据持久化

**关键数据结构**:
```cpp
struct BookmarkInfo {
    QString id;
    QString filePath;
    int pageIndex;
    QString title;
    QString description;
    QStringList tags;
    QDateTime timestamp;
};

struct ReadingProgress {
    QString filePath;
    int currentPage;
    int totalPages;
    qint64 readingTime;  // 毫秒
    QDateTime lastRead;
    double progress;     // 0.0-1.0
};
```

#### 3. DownloadManager (下载管理器)

**文件**: `src/managers/DownloadManager.h/cpp`

**职责**:
- HTTP下载任务管理
- 断点续传支持
- 下载进度和状态管理

**核心功能**:
```cpp
class DownloadManager {
public:
    // 添加下载任务
    void addDownload(const QUrl &url, const QString &savePath);
    
    // 控制下载
    void pauseDownload(const QString &id);
    void resumeDownload(const QString &id);
    void cancelDownload(const QString &id);
    
    // 设置限制
    void setMaxConcurrentDownloads(int max);
    void setSpeedLimit(int bytesPerSecond);
};
```

#### 4. ErrorHandler (错误处理器)

**文件**: `src/managers/ErrorHandler.h/cpp`

**职责**:
- 统一错误处理和分类
- 错误日志记录
- 用户通知管理

**错误分类**:
```cpp
enum class ErrorCategory {
    FileSystem,    // 文件系统错误
    Network,       // 网络错误
    Archive,       // 压缩包错误
    Memory,        // 内存错误
    UI,           // 界面错误
    Unknown       // 未知错误
};

enum class ErrorSeverity {
    Info,         // 信息
    Warning,      // 警告
    Error,        // 错误
    Critical      // 严重错误
};
```

## 架构设计

### 设计原则

1. **单一职责**: 每个类专注于单一功能
2. **接口隔离**: 最小化接口依赖
3. **依赖倒置**: 依赖抽象而非具体实现
4. **开闭原则**: 对扩展开放，对修改封闭

### 模块依赖图

```
MainWindow
    ├── LibraryWidget
    │   └── CacheManager
    ├── BookmarkManager
    ├── DownloadManager
    │   └── ErrorHandler
    └── SettingsDialog
        └── ErrorHandler (via ErrorLogDialog)
```

### 错误处理流程

```
Error Occurs → ErrorHandler::reportError()
    ├── 记录到日志文件
    ├── 更新错误统计
    ├── 发送系统通知（可选）
    └── 触发信号通知UI更新
```

## API文档

### CacheManager API

#### 构造函数
```cpp
CacheManager(QObject *parent = nullptr);
```

#### 缓存操作
```cpp
// 异步获取页面图片
void getPageAsync(const QString &archivePath, int pageIndex, 
                 std::function<void(const QPixmap&)> callback);

// 同步获取页面图片
QPixmap getPage(const QString &archivePath, int pageIndex);

// 预加载页面
void preloadPages(const QString &archivePath, 
                  const QList<int> &pageIndices);
```

#### 缓存配置
```cpp
// 设置内存缓存限制（MB）
void setMemoryCacheLimit(int sizeMB);

// 设置磁盘缓存限制（MB）
void setDiskCacheLimit(int sizeMB);

// 设置压缩质量（0-100）
void setCompressionQuality(int quality);

// 启用/禁用磁盘缓存
void setDiskCacheEnabled(bool enabled);
```

#### 缓存清理
```cpp
// 清理内存缓存
void clearMemoryCache();

// 清理磁盘缓存
void clearDiskCache();

// 清理特定文件的缓存
void clearFileCache(const QString &filePath);
```

### BookmarkManager API

#### 书签操作
```cpp
// 添加书签
void addBookmark(const BookmarkInfo &bookmark);

// 删除书签
void removeBookmark(const QString &id);

// 更新书签
void updateBookmark(const BookmarkInfo &bookmark);

// 获取所有书签
QList<BookmarkInfo> getAllBookmarks() const;

// 按文件路径获取书签
QList<BookmarkInfo> getBookmarksByFile(const QString &filePath) const;
```

#### 阅读进度
```cpp
// 更新阅读进度
void updateReadingProgress(const QString &filePath, int currentPage);

// 获取阅读进度
ReadingProgress getReadingProgress(const QString &filePath) const;

// 获取所有进度
QList<ReadingProgress> getAllProgress() const;
```

#### 搜索和过滤
```cpp
// 搜索书签
QList<BookmarkInfo> searchBookmarks(const QString &query) const;

// 按标签过滤
QList<BookmarkInfo> filterByTags(const QStringList &tags) const;

// 按时间范围过滤
QList<BookmarkInfo> filterByDateRange(const QDateTime &start, 
                                      const QDateTime &end) const;
```

### ErrorHandler API

#### 错误报告
```cpp
// 报告错误
void reportError(ErrorSeverity severity, ErrorCategory category,
                const QString &message, const QString &details = QString());

// 便捷宏
#define REPORT_ERROR(category, message) \
    ErrorHandler::instance().reportError(ErrorSeverity::Error, category, message)

#define REPORT_WARNING(category, message) \
    ErrorHandler::instance().reportError(ErrorSeverity::Warning, category, message)
```

#### 错误查询
```cpp
// 获取所有错误
QList<ErrorInfo> getAllErrors() const;

// 按严重程度过滤
QList<ErrorInfo> getErrorsBySeverity(ErrorSeverity severity) const;

// 按分类过滤
QList<ErrorInfo> getErrorsByCategory(ErrorCategory category) const;

// 获取错误统计
ErrorStatistics getStatistics() const;
```

## 单元测试

### 测试框架

使用Qt Test框架进行单元测试。

### 运行测试

```bash
# 构建测试
mkdir build-tests && cd build-tests
cmake ../tests
make

# 运行所有测试
./ComicReaderTests

# 运行特定测试
./ComicReaderTests TestCacheManager
```

### 测试覆盖率

```bash
# 启用覆盖率统计
cmake -DCMAKE_BUILD_TYPE=Debug -DENABLE_COVERAGE=ON ..
make coverage
```

### 编写测试

```cpp
class TestCacheManager : public QObject {
    Q_OBJECT

private slots:
    void initTestCase();        // 测试开始前
    void cleanupTestCase();     // 测试结束后
    void init();               // 每个测试前
    void cleanup();            // 每个测试后
    
    void testMemoryCache();    // 测试内存缓存
    void testDiskCache();      // 测试磁盘缓存
    void testClearCache();     // 测试缓存清理
};
```

## 代码规范

### 命名规范

**类名**: PascalCase
```cpp
class CacheManager;
class BookmarkManager;
```

**函数名**: camelCase
```cpp
void getPageAsync();
void updateBookmark();
```

**变量名**: camelCase
```cpp
int currentPage;
QString filePath;
```

**常量**: UPPER_SNAKE_CASE
```cpp
static const int MAX_CACHE_SIZE = 1024;
```

### 文件组织

**头文件**:
```cpp
#pragma once

#include <QtCore>
#include <QtWidgets>

// 前向声明
class QPixmap;

// 类声明
class CacheManager : public QObject {
    Q_OBJECT
    
public:
    // 公共接口
    
signals:
    // 信号
    
private slots:
    // 私有槽
    
private:
    // 私有成员
};
```

**实现文件**:
```cpp
#include "CacheManager.h"

#include <QDebug>
#include <QPixmap>

// 实现...
```

### 注释规范

**类注释**:
```cpp
/**
 * @brief 缓存管理器
 * 
 * 提供内存和磁盘两级缓存，支持异步图片加载和压缩。
 * 
 * @author 作者名
 * @date 2024-01-01
 */
class CacheManager {
```

**函数注释**:
```cpp
/**
 * @brief 异步获取页面图片
 * @param archivePath 压缩包路径
 * @param pageIndex 页面索引
 * @param callback 完成回调函数
 */
void getPageAsync(const QString &archivePath, int pageIndex,
                 std::function<void(const QPixmap&)> callback);
```

## 性能优化

### 内存优化

1. **智能指针**: 使用`std::unique_ptr`和`std::shared_ptr`
2. **对象池**: 重用昂贵对象
3. **懒加载**: 按需加载资源

### 缓存优化

1. **LRU算法**: 最近最少使用淘汰策略
2. **压缩存储**: JPEG压缩减少内存使用
3. **预取策略**: 智能预加载相邻页面

### 网络优化

1. **连接复用**: HTTP连接池
2. **并发控制**: 限制同时下载数
3. **断点续传**: 支持大文件下载

## 部署指南

### Windows部署

```bash
# 使用windeployqt工具
windeployqt.exe --qmldir . ComicReader.exe

# 创建安装包
makensis installer.nsi
```

### Linux部署

```bash
# AppImage打包
linuxdeploy --appdir AppDir --output appimage

# 或创建deb包
dpkg-buildpackage -us -uc
```

### macOS部署

```bash
# 创建App Bundle
macdeployqt ComicReader.app

# 代码签名
codesign --deep --force --verify --verbose --sign "Developer ID" ComicReader.app
```

## 贡献指南

### 开发流程

1. **Fork项目**: 从主仓库Fork
2. **创建分支**: `git checkout -b feature/new-feature`  
3. **编写代码**: 遵循代码规范
4. **编写测试**: 确保测试覆盖率
5. **提交变更**: `git commit -m "Add: new feature"`
6. **推送分支**: `git push origin feature/new-feature`
7. **创建PR**: 提交Pull Request

### 提交信息规范

```
<type>(<scope>): <subject>

<body>

<footer>
```

**类型**:
- `feat`: 新功能
- `fix`: 错误修复
- `docs`: 文档更新
- `style`: 代码格式
- `refactor`: 重构
- `test`: 测试相关
- `chore`: 构建过程或辅助工具的变动

### 代码审查

所有代码变更必须通过审查：
1. 功能正确性
2. 代码质量
3. 测试完整性
4. 文档更新

## 故障排除

### 构建问题

**Q: Qt版本不兼容**
```bash
# 检查Qt版本
qmake --version
# 或
cmake --version
```

**Q: 找不到头文件**
```cmake
# 确保CMakeLists.txt中包含
find_package(Qt6 REQUIRED COMPONENTS Core Widgets Network)
```

### 运行时问题

**Q: 程序崩溃**
1. 启用调试模式构建
2. 使用调试器定位问题
3. 检查错误日志

**Q: 内存泄漏**
```bash
# 使用Valgrind检测
valgrind --tool=memcheck --leak-check=full ./ComicReader
```

## 版本历史

### v1.0.0 (规划中)
- [x] 基础漫画阅读功能
- [x] 缓存系统
- [x] 书签管理
- [x] 下载管理器
- [x] 错误处理系统
- [ ] 用户界面优化
- [ ] 性能调优

---

**注意**: 本文档会随着项目发展持续更新，建议开发者定期查看最新版本。